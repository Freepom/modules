C51 COMPILER V9.00   MAIN                                                                  10/16/2017 11:24:38 PAGE 1   


C51 COMPILER V9.00, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\Objects\main.obj
COMPILER INVOKED BY: G:\Keil_v5\C51\BIN\C51.EXE main.c OPTIMIZE(8,SPEED) BROWSE INCDIR(.\SRC) DEBUG OBJECTEXTEND PRINT(.
                    -\Listings\main.lst) OBJECT(.\Objects\main.obj)

line level    source

   1          #include "main.h"
   2          #include "display.h"
   3          #include "ReadKey.h"
   4          
   5          //-----------------主循环架构的定义-----------------------------------
   6          
   7          u16 R_MainTemper;
   8          //u8    R_TimerMSCnt;
   9          u8      R_2ms=0;//2ms计时
  10          bit     Flg_2ms=0;
  11          bit     Flg_500MsFlash;
  12          char    R_JmpmsCnt=0;
  13          
  14          //char  R_MMode=0;
  15          //#define       D_Mode1 0
  16          //#define       D_Mode2 1
  17          //#define       D_Mode3 2
  18          //#define       D_Mode4 3
  19          //#define       D_Mode5 4
  20          //#define       D_Mode6 5
  21          
  22          //----------------------------------------------------------
  23          /**********************************************************************************/
  24          //----按键扫描、按键检测、按键处理的定义-----------------------------------
  25          
  26          sbit Pin_TimerSet       = P3^2;
  27          sbit Pin_Key1           = P1^5;
  28          sbit Pin_Key2           = P1^6;
  29          sbit Pin_Key3           = P1^7;
  30          sbit Pin_Key4           = P5^4;
  31          
  32          #define nokey           0
  33          #define D_key1          1
  34          #define D_key2          2
  35          #define D_key3          3
  36          #define D_key4          4
  37          #define D_keyTimerSet   5
  38          #define D_keyRelease    6
  39          
  40          
  41          //----------------------------------------------------------
  42          
  43          //----------------------------------------------------------
  44          u8 R_Second,R_Minute,R_Hour;
  45          
  46          //----------------------------------------------------------
  47          //-----------------------------------------
  48          //
  49          //函数声明
  50          //
  51          //-----------------------------------------
  52          
  53          void    NewDisplay2();
  54          void    DealKey();
C51 COMPILER V9.00   MAIN                                                                  10/16/2017 11:24:38 PAGE 2   

  55          void    KeyScan();
  56          void    UpdateDisplay();
  57          void    Timer50msCnt();
  58          void    initial();
  59          //-------------------------------------------
  60          /*---------------主循环---------------------
  61          //--------------------------------------------
  62          /输入：
  63          /输出：
  64          /备注：
  65          /       
  66          */
  67          //-------------------------------------------
  68          main()
  69          {
  70   1              initial();      //定时器初始化
  71   1      
  72   1              ClrWDT;                         
  73   1              while(1)
  74   1              {
  75   2              ClrWDT; 
  76   2      
  77   2              DealKey();      //按键处理
  78   2      
  79   2              if(Flg_2ms)     //10毫秒计时处理
  80   2                      {
  81   3                      Flg_2ms=0;
  82   3      
  83   3                      if(++R_JmpmsCnt == 10)R_JmpmsCnt=0;
  84   3                      switch(R_JmpmsCnt)      //2毫秒分时处理
  85   3                              {
  86   4                              case    0:
  87   4                  
  88   4                                      break;
  89   4                              case    1:
  90   4                                              UpdateDisplay();
  91   4                                      break;
  92   4                              case    2:
  93   4      
  94   4                                              
  95   4                                      break;                                                                                          
  96   4                              case    3:
  97   4      
  98   4                                      break;
  99   4                              case    4:
 100   4      //                                      
 101   4                                      break;
 102   4                              case    5:
 103   4                                              ReadR_KeyValue();       //按键转换
 104   4                                      break;
 105   4                              case    6:
 106   4                                              UpdateDisplay();
 107   4                                      break;
 108   4                              case    7:
 109   4      //                                      
 110   4                                              
 111   4                                      break;                                                                                          
 112   4                              case    8:
 113   4      //                                      
 114   4                                      break;
 115   4                              case    9:
 116   4                                              Timer50msCnt(); //20毫秒计时
C51 COMPILER V9.00   MAIN                                                                  10/16/2017 11:24:38 PAGE 3   

 117   4                                      break;
 118   4                              default:
 119   4                                      break;                                                                                                                          
 120   4                              }
 121   3                      }       
 122   2              }
 123   1      }
 124          //-------------------------------------------
 125          /*---------------定时器中断子程序------------
 126          /输入：定时器T0中断
 127          /输出：2毫秒标志Flg_2ms=1，按键扫描
 128          /备注：定时器0方式2,16位自动重载，定时125us
 129          /
 130          */
 131          //-------------------------------------------
 132          void et0()interrupt 1
 133          {
 134   1              static u8 R_MSCnt=0;
 135   1      //      TL0 = 0x9A;             //设置定时初值
 136   1      //      TH0 = 0xFA;             //设置定时初值125us     
 137   1                      
 138   1              R_MSCnt++;                              
 139   1              if(R_MSCnt == 16)
 140   1                      {
 141   2                      R_MSCnt=0;
 142   2                      Flg_2ms=1;      
 143   2                      }
 144   1              
 145   1      //      BeepDrv();
 146   1              KeyScan();      //按键扫描
 147   1      
 148   1      
 149   1      }
 150          
 151          //串行中断函数
 152          void serial() interrupt 4
 153          {
 154   1      
 155   1              if(0x7F == SBUF) //? ? ? ? ? ? ?//判断是否为下载流信息
 156   1              {
 157   2              IAP_CNTR =IAP_ENABLE; //?//允许IAP, 也就是直接进入下载程序
 158   2              // soft_reset();
 159   2              }
 160   1      }
 161          
 162          //-------------------------------------------
 163          /*---------------显示数据更新子程序------------
 164          //--------------------------------------------
 165          /输入：需要显示的数据
 166          /输出：显示缓存R_DBUF1,R_DBUF2,R_DBUF3,R_DBUF4等，用于显示驱动层
 167          /备注：放在2毫米分时中调用
 168          /
 169          */
 170          //-------------------------------------------
 171          void    UpdateDisplay()
 172          {
 173   1      
 174   1              R_DBUF1=0,R_DBUF2=0,R_DBUF3=0,R_DBUF4=0;
 175   1                                                      
 176   1      }
 177          
 178          //-------------------------------------------
C51 COMPILER V9.00   MAIN                                                                  10/16/2017 11:24:38 PAGE 4   

 179          /*---------------20毫秒计时子程序------------
 180          //--------------------------------------------
 181          /输入：需要计时的变量
 182          /输出：个变量预算后的结果
 183          /备注：放在2毫米分时中调用
 184          /       计时单位有：20ms，500ms，1S
 185          */
 186          //-------------------------------------------
 187          void    Timer50msCnt()
 188          {
 189   1              static char R_500msCnt,R_100msCnt;              
 190   1              R_500msCnt++;
 191   1              R_100msCnt++;
 192   1      
 193   1                      
 194   1      //----------计时50ms------------------------------------                
 195   1              {
 196   2              if(R_100msCnt==5)
 197   2                      {
 198   3                      R_100msCnt=0;
 199   3                      }       
 200   2                              
 201   2              }
 202   1      //----------计时20ms---END---------------------------------     
 203   1      
 204   1      //----------计时500ms------------------------------------       
 205   1              if(R_500msCnt == 25)
 206   1                      {
 207   2                      R_500msCnt=0;   
 208   2                      
 209   2      //----------此段为500ms------------------------------------
 210   2      
 211   2                      Flg_500MsFlash=!Flg_500MsFlash; 
 212   2      
 213   2      //----------计时1s------------------------------------                          
 214   2                      if(Flg_500MsFlash)
 215   2                              {
 216   3                                                      
 217   3                              R_Second++;
 218   3      
 219   3                              if(R_Second==60)
 220   3                                      {
 221   4                                      R_Second=0;
 222   4                                                                      
 223   4                                      R_Minute++;
 224   4                                      if(R_Minute==60)
 225   4                                              {
 226   5                                              R_Minute=0;
 227   5                                              R_Hour++;
 228   5                                              if(R_Hour==24)
 229   5                                                      {
 230   6                                                      R_Hour=0;       
 231   6                                                      }
 232   5                      
 233   5                                              }       
 234   4                                      }
 235   3                      
 236   3      //------        ----此段为1s------------------------------------                        
 237   3                      
 238   3                              }               
 239   2      //----------计时1s---END---------------------------------                                       
 240   2                      }
C51 COMPILER V9.00   MAIN                                                                  10/16/2017 11:24:38 PAGE 5   

 241   1      //----------计时500ms--END----------------------------------
 242   1      
 243   1                              
 244   1                              
 245   1      }
 246          
 247          //-------------------------------------------
 248          /*---------------按键处理子程序------------
 249          //--------------------------------------------
 250          /输入：按键产生标志Flg_HaveKey，按键键值R_CurKey，双击键产生标志FLG_keyDouble，
 251          /       按键未释放标志FLG_keymark,长按键产生标志Flg_LongKey
 252          /输出：各个按键功能
 253          /备注：主循环中调用
 254          /
 255          */
 256          //-------------------------------------------
 257          void    DealKey()//放在主循环中执行
 258          {
 259   1              u8      R_BottomMode=0;
 260   1              if(Flg_HaveKey == 0)
 261   1                      {
 262   2                      return; 
 263   2                      }
 264   1              Flg_HaveKey=0;  
 265   1      
 266   1                       R_BottomMode = R_CurKey;
 267   1      
 268   1                       switch(R_BottomMode)
 269   1                              {
 270   2                              case D_key1:    
 271   2      
 272   2                                      break;
 273   2      
 274   2                              case D_key2:
 275   2      
 276   2                                      break;
 277   2                              case D_key3: 
 278   2      
 279   2                                      break;
 280   2                              case D_key4:    
 281   2      
 282   2                                      break;  
 283   2                              case D_keyRelease://按键释放键  
 284   2      
 285   2                                      break;                                                                                                                  
 286   2                              case D_keyTimerSet:
 287   2      //                                      EnableDoubleKey();
 288   2      //                                      if(!FLG_keyDouble)
 289   2      //                                              {
 290   2      //                                              break;  
 291   2      //                                              }
 292   2      //                                      FLG_keyDouble=0;                                                
 293   2      
 294   2                                      break;
 295   2      
 296   2      
 297   2                                      break;                          
 298   2                      
 299   2                               default:;                         
 300   2                                       break;
 301   2                              }
 302   1      
C51 COMPILER V9.00   MAIN                                                                  10/16/2017 11:24:38 PAGE 6   

 303   1      }
 304          
 305          //-------------------------------------------
 306          /*---------------按键扫描子程序------------
 307          //--------------------------------------------
 308          /输入：
 309          /输出：各个按键键值R_KeyValue，用于按键中间层使用
 310          /备注：定时器中断子程序中调用
 311          /
 312          */
 313          //-------------------------------------------   
 314          void    KeyScan()//放在中断函数中执行125us执行一次
 315          {
 316   1              R_KeyValue=0;
 317   1              if(!Pin_Key1)
 318   1                      {
 319   2                      R_KeyValue=D_key1;
 320   2                      }
 321   1                      else
 322   1                              {
 323   2      
 324   2                              }
 325   1              if(!Pin_Key2)
 326   1                      {
 327   2                      R_KeyValue=D_key2;
 328   2                      }
 329   1                      else
 330   1                              {
 331   2      
 332   2                              }               
 333   1              if(!Pin_Key3)
 334   1                      {
 335   2                      R_KeyValue=D_key3;
 336   2                      }
 337   1                      else
 338   1                              {
 339   2      
 340   2                              }               
 341   1              if(!Pin_Key4)
 342   1                      {
 343   2                      R_KeyValue=D_key4;
 344   2                      }
 345   1                      else
 346   1                              {
 347   2              
 348   2                              }                               
 349   1              if(!Pin_TimerSet)
 350   1                      {
 351   2                      R_KeyValue=D_keyTimerSet;       
 352   2                      }
 353   1                                      
 354   1      
 355   1                                                                                                                                      
 356   1      }
 357          
 358          //-------------------------------------------
 359          /*---------------初始化子程序------------
 360          //--------------------------------------------
 361          /输入：
 362          /输出：
 363          /备注：定时器初始化，看门狗初始化
 364          /
C51 COMPILER V9.00   MAIN                                                                  10/16/2017 11:24:38 PAGE 7   

 365          */
 366          //-------------------------------------------   
 367          void initial()
 368          {
 369   1              P0M0 = 0x00;
 370   1              P0M1 = 0x00;
 371   1              P1M0 = 0x00;
 372   1              P1M1 = 0x00;
 373   1              P2M0 = 0x00;
 374   1              P2M1 = 0x00;
 375   1              P3M0 = 0x0a;
 376   1              P3M1 = 0x08;
 377   1              P4M0 = 0x00;
 378   1              P4M1 = 0x00;
 379   1              P5M0 = 0x00;
 380   1              P5M1 = 0x00;
 381   1              P6M0 = 0x00;
 382   1              P6M1 = 0x00;
 383   1               AUXR |= 0x80;                   //定时器0为1T模式
 384   1      //       AUXR &= 0x7f;                   //定时器0为12T模式
 385   1              TMOD &= 0xf0;           //设置定时器模式 工作方式0,16位自动重载 
 386   1      //      TL0 = 0x9A;             //设置定时初值
 387   1      //      TH0 = 0xFA;             //设置定时初值 
 388   1      //      TL0 = 0x33;             //设置定时初值
 389   1      //      TH0 = 0xF5;             //设置定时初值
 390   1              TL0 = T1Timer;          //设置定时初值
 391   1              TH0 = T1Timer>>8;               //设置定时初值125us 
 392   1              TR0 = 1;                        //定时器0开始计时
 393   1              ET0 = 1;                        //使能定时器0中断
 394   1      //------------------------------------------
 395   1      
 396   1              SCON = 0x50;            //8位数据,可变波特率
 397   1              AUXR |= 0x01;           //串口1选择定时器2为波特率发生器 9600
 398   1              AUXR |= 0x04;           //定时器2时钟为Fosc,即1T
 399   1      //      T2L = 0xC0;             //设定定时初值  22.M
 400   1      //      T2H = 0xFD;             //设定定时初值
 401   1              T2L = 0xE0;             //设定定时初值
 402   1              T2H = 0xFE;             //设定定时初值  11092500L
 403   1              AUXR |= 0x10;           //启动定时器2
 404   1      //------------------------------------------    
 405   1      //      AUXR |= 0x40;           //定时器1时钟为Fosc,即1T
 406   1      //      AUXR &= 0xFE;           //串口1选择定时器1为波特率发生器
 407   1      //      SCON = 0x5a;                    //8 bit data ,no parity bit
 408   1      //      TMOD = 0x20;                    //T1 as 8-bit auto reload
 409   1      ////            TH1 = TL1 = -(FOSC/32/BAUD); //Set Uart baudrate
 410   1      //      TL1 = 0xB8;             //设定定时初值
 411   1      //      TH1 = 0xB8;             //设定定时器重装值
 412   1      //      TR1 = 1;                        //T1 start running
 413   1      ////---------------------------------------------       
 414   1              ES = 1;                 //Enable UART interrupt
 415   1              EA = 1;
 416   1              
 417   1      //---------------------------------------------------------------------
 418   1          WDT_CONTR = 0x02;       //看门狗定时器溢出时间计算公式: (12 * 32768 * PS) / FOSC (秒)
 419   1                                  //设置看门狗定时器分频数为32,溢出时间如下:
 420   1                                  //11.0592M : 1.14s
 421   1                                  //18.432M  : 0.68s
 422   1                                  //20M      : 0.63s
 423   1          WDT_CONTR |= 0x20;      //启动看门狗  
 424   1          
 425   1       
 426   1      }
C51 COMPILER V9.00   MAIN                                                                  10/16/2017 11:24:38 PAGE 8   



MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    331    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     15    ----
   IDATA SIZE       =     16    ----
   BIT SIZE         =      2    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
