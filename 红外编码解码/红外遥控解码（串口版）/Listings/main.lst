C51 COMPILER V9.00   MAIN                                                                  10/20/2017 11:12:13 PAGE 1   


C51 COMPILER V9.00, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\Objects\main.obj
COMPILER INVOKED BY: G:\Keil_v5\C51\BIN\C51.EXE main.c OPTIMIZE(8,SPEED) BROWSE INCDIR(.\SRC) DEBUG OBJECTEXTEND PRINT(.
                    -\Listings\main.lst) OBJECT(.\Objects\main.obj)

line level    source

   1          /*--------------------------------------------------------------
   2          /项目名：
   3          /开发工程师：
   4          /日期：
   5          /版本：
   6          /主控MCU：51单片机，stc15W系列，晶振：11.0592MHz
   7          /备注：红外接收头：1838B型号
   8          /
   9          /
  10          *///------------------------------------------------------------------
  11          
  12          #include "main.h"
  13          #include "Reciving_IR.h"
  14          
  15                  
  16          #define FOSC    11092500L//22118400L//
  17          #define BAUD    9600
  18          #define D_T1Timer 0xFc00        //17.7MS
  19          #define D_T0Timer (65536-FOSC/8000)
  20          #define PinPP(Pn,n) {switch(Pn){\                                                       
  21                                  case 0:P0M1 &= ~(1 << n);P0M0 |=  (1 << n);break;\
  22                                  case 1:P1M1 &= ~(1 << n);P1M0 |=  (1 << n);break;\
  23                                  case 2:P2M1 &= ~(1 << n);P2M0 |=  (1 << n);break;\
  24                                  case 3:P3M1 &= ~(1 << n);P3M0 |=  (1 << n);break;\
  25                                  case 4:P4M1 &= ~(1 << n);P4M0 |=  (1 << n);break;\
  26                                  case 5:P5M1 &= ~(1 << n);P5M0 |=  (1 << n);break;\                                                                              
  27                                  default:break;\                                                                                                                                                         
  28                                  }\
  29                              }
  30                              
  31          #define ClrWDT  {WDT_CONTR |= 0x10;}//清看门狗，喂狗程序                        
  32          #define IAP_ENABLE 0x60 //IAP允许
  33          sfr IAP_CNTR = 0xC7; //IAP控制寄存器
  34          //---------------------------------------------
  35          
  36          
  37          //-----------------主循环架构的定义-----------------------------------
  38          
  39          u16 R_MainTemper;
  40          //u8    R_TimerMSCnt;
  41          u8      R_2ms=0;//2ms计时
  42          bit     Flg_2ms=0;
  43          bit     Flg_500MsFlash;
  44          char    R_JmpmsCnt=0;
  45          
  46          
  47          u8      R_MainMode=0;
  48          //----------------------------------------------------------
  49          
  50          //----------------------------------------------------------
  51          #define D_BeepTm 10     //20MS
  52          #define Beep() {R_BeepTm=D_BeepTm;R_BeepFrq=10;}
  53          u8 R_BeepCnt;
  54          u8 R_BeepTm=D_BeepTm;
C51 COMPILER V9.00   MAIN                                                                  10/20/2017 11:12:13 PAGE 2   

  55          
  56          
  57          u8 R_BeepFrq,R_BeepFrqBak;
  58          
  59          sbit Pin_Beep   = P0^4;
  60          
  61          //-----------------------------------------
  62          //
  63          //函数声明
  64          //
  65          //-----------------------------------------
  66          
  67          u8 DealRFKey(u8 R_Data);
  68          void BeepDrv();
  69          
  70          void    Timer50msCnt();
  71          void    Init_System();
  72          //-------------------------------------------
  73          /*---------------主循环---------------------
  74          //--------------------------------------------
  75          /输入：
  76          /输出：
  77          /备注：
  78          /       
  79          */
  80          //-------------------------------------------
  81          main()
  82          {
  83   1          u8 Cnt;
  84   1              Init_System();  //定时器初始化
  85   1          Pin_IR=1;
  86   1              ClrWDT;                         
  87   1              while(1)
  88   1              {
  89   2              ClrWDT; 
  90   2      
  91   2      
  92   2              if(Flg_2ms)     //2毫秒分时处理
  93   2                      {
  94   3                      Flg_2ms=0;
  95   3              
  96   3           if(Flg_RxIROK)//红外接收完成
  97   3          {
  98   4             
  99   4              if(Cnt<D_RxByteCnt)
 100   4              {
 101   5                  SBUF=RxData_Tab[Cnt];
 102   5                  while(!TI);
 103   5                  TI=0;
 104   5                   Cnt++;
 105   5              }
 106   4              else
 107   4              {
 108   5              Cnt=0; Flg_RxIROK=0;
 109   5             }
 110   4             
 111   4          }       
 112   3                      if(++R_JmpmsCnt == 10)R_JmpmsCnt=0;
 113   3                      switch(R_JmpmsCnt)      //2毫秒分时处理
 114   3                              {
 115   4                              case    0:
 116   4                                              
C51 COMPILER V9.00   MAIN                                                                  10/20/2017 11:12:13 PAGE 3   

 117   4                                      break;
 118   4                              case    1:
 119   4                                              
 120   4                                      break;
 121   4                              case    2:
 122   4                                              
 123   4                                      break;                                                                                          
 124   4                              case    3:
 125   4      
 126   4                                      break;
 127   4                              case    4:
 128   4      
 129   4                                      break;
 130   4                              case    5:
 131   4                                              
 132   4                                      break;
 133   4                              case    6:
 134   4                                              
 135   4                                      break;
 136   4                              case    7:                                      
 137   4                                      
 138   4                                      break;                                                                                          
 139   4                              case    8:
 140   4      
 141   4                                      break;
 142   4                              case    9:
 143   4                                              Timer50msCnt(); //20毫秒计时
 144   4                                      break;
 145   4                              default:
 146   4                                      break;                                                                                                                          
 147   4                              }
 148   3                      }       
 149   2              }
 150   1      }
 151          /*输入：定时器T0中断
 152          /输出：2毫秒标志Flg_2ms=1，按键扫描
 153          /备注：定时器0方式2,16位自动重载，定时125us
 154          /
 155          */
 156          //-------------------------------------------
 157          void et0()interrupt 1
 158          {
 159   1              
 160   1              static u8 R_MSCnt=0;
 161   1      //      TL0 = 0x9A;             //设置定时初值
 162   1      //      TH0 = 0xFA;             //设置定时初值125us             
 163   1              R_MSCnt++;                              
 164   1              if(R_MSCnt == 16)
 165   1                      {
 166   2                      R_MSCnt=0;
 167   2                      Flg_2ms=1;      
 168   2                      }       
 169   1              BeepDrv();
 170   1              REciving_IR();
 171   1                                                      
 172   1      }
 173          void    Timer50msCnt()
 174          {
 175   1              static char R_500msCnt,R_100msCnt;              
 176   1              R_500msCnt++;
 177   1              R_100msCnt++;
 178   1                      
C51 COMPILER V9.00   MAIN                                                                  10/20/2017 11:12:13 PAGE 4   

 179   1      //----------计时50ms------------------------------------                
 180   1              {
 181   2              if(R_100msCnt==5)
 182   2                      {
 183   3                      R_100msCnt=0;
 184   3      
 185   3                      }       
 186   2                              
 187   2              }
 188   1      //----------计时20ms---END---------------------------------     
 189   1      
 190   1      //----------计时500ms------------------------------------       
 191   1              if(R_500msCnt == 25)
 192   1                      {
 193   2                      R_500msCnt=0;   
 194   2      
 195   2      //----------此段为500ms------------------------------------
 196   2      
 197   2                      Flg_500MsFlash=!Flg_500MsFlash; 
 198   2      
 199   2      //----------计时1s------------------------------------                          
 200   2                      if(Flg_500MsFlash)
 201   2                              {
 202   3                                                      
 203   3                      
 204   3      //------        ----此段为1s------------------------------------                        
 205   3                      
 206   3                              }               
 207   2      //----------计时1s---END---------------------------------                                       
 208   2                      }
 209   1      //----------计时500ms--END----------------------------------
 210   1      
 211   1                              
 212   1                              
 213   1      }
 214          //-------------------------------------------
 215          /*---------------定时器中断子程序------------
 216          /输入：定时器T0中断
 217          /输出：RGB输出控制，时钟显示
 218          /备注：定时器0方式2,16位自动重载，
 219          /
 220          */
 221          //-------------------------------------------
 222          
 223          //串行中断函数
 224          void serial() interrupt 4
 225          {
 226   1      
 227   1      //      RxDataTemp_Tab[R_RxCnt]=SBUF;// 
 228   1              RI=0;
 229   1              if(0x7F == SBUF) //? ? ? ? ? ? ?//判断是否为下载流信息
 230   1              {
 231   2              IAP_CNTR =IAP_ENABLE; //?//允许IAP, 也就是直接进入下载程序
 232   2              // soft_reset();
 233   2              }
 234   1      
 235   1      }
 236          
 237          //-------------------------------------------
 238          /*---------------蜂鸣器子程序------------
 239          //--------------------------------------------
 240          /输入：
C51 COMPILER V9.00   MAIN                                                                  10/20/2017 11:12:13 PAGE 5   

 241          /输出：
 242          /备注：
 243          /
 244          */
 245          //-------------------------------------------   
 246          void BeepDrv()
 247          {
 248   1              if(R_BeepTm)
 249   1                      {
 250   2                      if(R_BeepFrq)
 251   2                              {
 252   3                              R_BeepFrq--;
 253   3                              if(R_BeepFrq==0)
 254   3                                      {
 255   4                                      R_BeepFrq=R_BeepFrqBak;
 256   4                                      Pin_Beep=!Pin_Beep;     
 257   4                                      }
 258   3                                      
 259   3                              }
 260   2                              
 261   2                      }       
 262   1                      else
 263   1                              {
 264   2                              Pin_Beep=1;     
 265   2                              }
 266   1                              
 267   1      }
 268          
 269          
 270          //-------------------------------------------
 271          /*---------------初始化子程序------------
 272          //--------------------------------------------
 273          /输入：
 274          /输出：
 275          /备注：定时器初始化，看门狗初始化
 276          /
 277          */
 278          //-------------------------------------------   
 279          void Init_System()
 280          {
 281   1              P0M0 = 0x00;
 282   1              P0M1 = 0x00;
 283   1              P1M0 = 0x00;
 284   1              P1M1 = 0x00;
 285   1              P2M0 = 0x00;
 286   1              P2M1 = 0x00;
 287   1              P3M0 = 0x0a;
 288   1              P3M1 = 0x08;
 289   1              P4M0 = 0x00;
 290   1              P4M1 = 0x00;
 291   1              P5M0 = 0x00;
 292   1              P5M1 = 0x00;
 293   1              P6M0 = 0x00;
 294   1              P6M1 = 0x00;
 295   1               AUXR |= 0x80;                   //定时器0为1T模式
 296   1      //       AUXR &= 0x7f;                   //定时器0为12T模式
 297   1              TMOD &= 0xf0;           //设置定时器模式 工作方式0,16位自动重载 
 298   1      //      TL0 = 0x9A;             //设置定时初值
 299   1      //      TH0 = 0xFA;             //设置定时初值 
 300   1      //      TL0 = 0x33;             //设置定时初值
 301   1      //      TH0 = 0xF5;             //设置定时初值
 302   1              TL0 = D_T0Timer;                //设置定时初值
C51 COMPILER V9.00   MAIN                                                                  10/20/2017 11:12:13 PAGE 6   

 303   1              TH0 = D_T0Timer>>8;             //设置定时初值125us 
 304   1              TR0 = 1;                        //定时器0开始计时
 305   1              ET0 = 1;                        //使能定时器0中断
 306   1      //------------------------------------------
 307   1      
 308   1              SCON = 0x50;            //8位数据,可变波特率
 309   1              AUXR |= 0x01;           //串口1选择定时器2为波特率发生器 9600
 310   1              AUXR |= 0x04;           //定时器2时钟为Fosc,即1T
 311   1      //      T2L = 0xC0;             //设定定时初值  22.M
 312   1      //      T2H = 0xFD;             //设定定时初值
 313   1              T2L = 0xE0;             //设定定时初值
 314   1              T2H = 0xFE;             //设定定时初值  11092500L
 315   1              AUXR |= 0x10;           //启动定时器2
 316   1      
 317   1      //------------------------------------------    
 318   1      //      AUXR |= 0x40;           //定时器1时钟为Fosc,即1T
 319   1      //      AUXR &= 0xFE;           //串口1选择定时器1为波特率发生器
 320   1      //      SCON = 0x5a;                    //8 bit data ,no parity bit
 321   1      //      TMOD = 0x20;                    //T1 as 8-bit auto reload
 322   1      ////            TH1 = TL1 = -(FOSC/32/BAUD); //Set Uart baudrate
 323   1      //      TL1 = 0xB8;             //设定定时初值
 324   1      //      TH1 = 0xB8;             //设定定时器重装值
 325   1      //      TR1 = 1;                        //T1 start running
 326   1      ////---------------------------------------------       
 327   1              ES = 1;                 //Enable UART interrupt
 328   1              EA = 1;
 329   1              
 330   1      //---------------------------------------------------------------------
 331   1          WDT_CONTR = 0x02;       //看门狗定时器溢出时间计算公式: (12 * 32768 * PS) / FOSC (秒)
 332   1                                  //设置看门狗定时器分频数为32,溢出时间如下:
 333   1                                  //11.0592M : 1.14s
 334   1                                  //18.432M  : 0.68s
 335   1                                  //20M      : 0.63s
 336   1          WDT_CONTR |= 0x20;      //启动看门狗  
 337   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    283    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     12       1
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      2    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
